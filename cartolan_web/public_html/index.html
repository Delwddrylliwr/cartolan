<!doctype html>
<html class="no-js" lang="">

    <head>
        <meta charset="utf-8">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta property="og:title" content="">
        <meta property="og:type" content="">
        <meta property="og:url" content="">
        <meta property="og:image" content="">

        <link rel="manifest" href="site.webmanifest">
        <link rel="apple-touch-icon" href="icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">

        <meta name="theme-color" content="#fafafa">
        
        <!--<script src="download.js" type="text/javascript"></script>-->
        
        <style>
            body {
                margin: 0;
            }
            canvas {
                border:1px solid #d3d3d3;
                background-color: #f1f1f1;
            }
        </style>
    </head>

    <body onload="startGame()">

        <script>
            var canvas;
            var context;
            var websocket;
//            var canvas = document.getElementById('stage');
//            var context = canvas.getContext("2d");

            function openWS(){
                websocket = new WebSocket("ws:localhost:10000");
                websocket.binaryType = "arraybuffer";
                websocket.onmessage = function(evt) { onMessage(evt); };
                websocket.onerror = function(evt) { onError(evt); };
                websocket.onopen = function(evt) { onOpen(evt); };
                
                function onOpen(evt){
//                    //Establish user credentials
//                    var luser = document.getElementById("lusername").value;
//                    var ruser = document.getElementById("rusername").value;
//                    var pwd = document.getElementById("password").value;
                    console.log("Connecting.. ");
//                    //Share credentials with server
//                    websocket.send("SUB[00100]" + luser);
//                    websocket.send("MESSAGE[00100]" + ruser + "[11111]" + pwd);
//                    
                    console.log("Requesting to join a game from the server.");
                    //pass the play area dimensions to the server
                    send("START[00100]" + myGameArea.canvas.width + "[55555]" + myGameArea.canvas.height);
                    //@TODO wait for server response to confirm connection
                    console.log("Connected.");
                    //@TODO share the dimensions of the client play area with the server so that rescaling of the image can happen serverside before transmission
                }

                function onMessage(evt) {
                    decomposed = evt.data.split("[00100]")
                    console.log("Data received of type: "+evt.data.type)
                    if (decomposed[0] === 'PING') { // this is a heartbeat message
                        this.send("PONG[00100]");
                    }
                    else if (decomposed[0] === 'TEXT') { // accept only text
                        console.log("Text prompt received: "+decomposed[1])
                        var input = prompt(decomposed[1]);
                        console.log("input: " + input);
                        this.send("TEXT[00100]" + input);
                    } else if (decomposed[0] === 'IMAGE') { //this is a base64 image to render
                        var img = new Image();
                        console.log("Image received.");
//                        download(decomposed[1], "test.png");
//                        img.src = "data:image/png;base64, "+btoa(decomposed[1]);
                        img.onload = function () {
                            context.fillStyle = "red";
                            context.fillRect(0, 0, 100, 100);
                            context.drawImage(img,0,0);
                            console.log("Image drawn to canvas. ");
                        };
//                        img.src = "data:image/png;base64, "+btoa(decomposed[1]);
                        imageString = decomposed[1].toString().substring(1).replace(/'/g, "");
                        console.log(imageString);
                        img.src = "data:image/png;base64, "+imageString;
                    } else {
                        console.log("Received message couldn't be processed.");
                    };
                }

                function onError(evt) {
                    console.log(evt.data);
                }
            }
            
               
            function send(message) {
                console.log("Trying to send message: "+message)
                waitForConnection(function () {
                    websocket.send(message);
                }, 1000);
            };

            function waitForConnection(callback, interval) {
                if (websocket.readyState === 1) {
                    console.log("Web socket found open.")
                    callback();
                }
            };
            
            function startGame() {
                //initiate a play area of a suitable size within the browser window
                myGameArea.start();
                //set up the websocket connection to the game server
                openWS();
            }

            var myGameArea = {
                canvas: document.createElement("canvas"),
                start: function () {
                    canvas = this.canvas;
                    this.canvas.width = window.innerWidth; //get this from the browser window size
                    this.canvas.height = window.innerHeight; //get this from the browser window size
                    this.context = this.canvas.getContext("2d");
                    context = this.context;
                    document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                    this.interval = setInterval(updateGameArea, 20);
                    window.addEventListener('mousedown', function (e) {
                        myGameArea.x = e.pageX;
                        myGameArea.y = e.pageY;
                    });
                    window.addEventListener('mouseup', function (e) {
                        myGameArea.x = false;
                        myGameArea.y = false;
                    });
                    window.addEventListener('touchstart', function (e) {
                        myGameArea.x = e.pageX;
                        myGameArea.y = e.pageY;
                    });
                    window.addEventListener('touchend', function (e) {
                        myGameArea.x = false;
                        myGameArea.y = false;
                    });
                },
                clear: function () {
                    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    console.log("Cleared inputs.");
                }
            };

            function updateGameArea() {
//                myGameArea.clear();
                if (myGameArea.x && myGameArea.y) {
                    send("COORDS[00100]" + myGameArea.x 
                            + "[66666]" + myGameArea.y);
                    console.log("Shared coordinates.")
                }
            }

        </script>

<!--         Google Analytics: change UA-XXXXX-Y to be your site's ID. 
        <script>
            window.ga = function () {
                ga.q.push(arguments); }; ga.q = [];
            ga.l = +new Date;
            ga('create', 'UA-XXXXX-Y', 'auto');
            ga('set', 'anonymizeIp', true);
            ga('set', 'transport', 'beacon');
            ga('send', 'pageview');
        </script>
        <script src="https://www.google-analytics.com/analytics.js" async></script>-->
    </body>

</html>
